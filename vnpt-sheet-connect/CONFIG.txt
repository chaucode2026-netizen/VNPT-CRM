
/**
 * FILE 3: CONFIGURATION MANAGEMENT
 * Quản lý các danh mục: Mã Lớp, Giảng Viên, Đơn Vị
 */

function getConfigSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  // Sử dụng hằng số từ BACKEND_CONSTANTS.gs
  var sheet = ss.getSheetByName(CONFIG_SHEET); 
  if (!sheet) {
    sheet = ss.insertSheet(CONFIG_SHEET);
    // Tạo header
    sheet.getRange("A1:C1").setValues([["MA_LOP", "GIANG_VIEN", "DON_VI"]]);
    sheet.getRange("A1:C1").setFontWeight("bold");
  }
  return sheet;
}

function getConfig() {
  var sheet = getConfigSheet();
  var lastRow = sheet.getLastRow();
  
  var classCodes = [];
  var instructors = [];
  var units = [];

  if (lastRow > 1) {
    var data = sheet.getRange(2, 1, lastRow - 1, 3).getValues();
    
    for (var i = 0; i < data.length; i++) {
      if (data[i][0]) classCodes.push(data[i][0]);
      if (data[i][1]) instructors.push(data[i][1]);
      if (data[i][2]) units.push(data[i][2]);
    }
  }

  // Nếu chưa có dữ liệu, trả về mặc định để không bị lỗi giao diện
  if (classCodes.length === 0) classCodes = ['VNPT-DEFAULT'];
  if (instructors.length === 0) instructors = ['Giảng viên mẫu'];
  if (units.length === 0) units = ['TTKD'];

  // Trả về ContentService JSON trực tiếp
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    config: {
      classCodes: classCodes,
      instructors: instructors,
      units: units
    }
  })).setMimeType(ContentService.MimeType.JSON);
}

function saveConfig(data) {
  try {
    // 1. Kiểm tra quyền Admin
    if (!data.user || data.user.role !== 'ADMIN') {
      return ContentService.createTextOutput(JSON.stringify({
        error: "Bạn không có quyền thực hiện thao tác này."
      })).setMimeType(ContentService.MimeType.JSON);
    }

    var config = data.config; // { classCodes: [], instructors: [], units: [] }
    var sheet = getConfigSheet();
    
    // 2. Xóa dữ liệu cũ (Giữ lại Header dòng 1)
    var lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      sheet.getRange(2, 1, lastRow - 1, 3).clearContent();
    }

    // 3. Chuẩn bị dữ liệu mới
    var maxLen = Math.max(config.classCodes.length, config.instructors.length, config.units.length);
    if (maxLen === 0) {
        return ContentService.createTextOutput(JSON.stringify({ success: true })).setMimeType(ContentService.MimeType.JSON);
    }

    var rows = [];
    for (var i = 0; i < maxLen; i++) {
      rows.push([
        config.classCodes[i] || "",
        config.instructors[i] || "",
        config.units[i] || ""
      ]);
    }

    // 4. Ghi xuống Sheet
    sheet.getRange(2, 1, rows.length, 3).setValues(rows);

    return ContentService.createTextOutput(JSON.stringify({
      success: true
    })).setMimeType(ContentService.MimeType.JSON);

  } catch (e) {
    return ContentService.createTextOutput(JSON.stringify({
      error: "Lỗi lưu cấu hình: " + e.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}
